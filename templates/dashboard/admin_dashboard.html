{% extends 'base.html' %}
{% load static %}

{% block title %}لوحة تحكم الأدمن - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Welcome Header -->
    <div class="bg-gradient-to-r from-primary-600 to-primary-800 dark:from-primary-800 dark:to-primary-950 rounded-2xl p-8 mb-8 text-white relative overflow-hidden">
        <!-- خلفية مزخرفة -->
        <div class="absolute top-0 left-0 w-64 h-64 bg-white opacity-5 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-white opacity-5 rounded-full translate-x-1/3 translate-y-1/3"></div>
        
        <div class="flex items-center justify-between relative z-10">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl font-bold">مرحباً {{ user.first_name|default:user.username }}!</h1>
                    <!-- عرض شارة السوبر أدمن -->
                    {% if user.is_superuser %}
                    <span class="px-3 py-1 bg-yellow-400 text-yellow-900 rounded-full text-sm font-bold flex items-center gap-1">
                        <i class="fas fa-crown"></i>
                        سوبر أدمن
                    </span>
                    {% endif %}
                    {% if user.role == 'admin' %}
                    <span class="px-3 py-1 bg-purple-400 text-purple-900 rounded-full text-sm font-bold flex items-center gap-1">
                        <i class="fas fa-user-tie"></i>
                        مدير
                    </span>
                    {% endif %}
                </div>
                <p class="text-white/90">لوحة تحكم المدير العام - إدارة كاملة للمنصة والمحتوى</p>
            </div>
            <div class="hidden md:block">
                <i class="fas fa-crown text-6xl opacity-50"></i>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm">إجمالي المستخدمين</p>
                    <h3 class="text-3xl font-bold">{{ total_users|default:'0' }}</h3>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-users text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-2 text-sm text-blue-100">
                <div class="text-center">
                    <span class="font-bold">{{ total_students|default:'0' }}</span>
                    <p class="text-xs">طلاب</p>
                </div>
                <div class="text-center">
                    <span class="font-bold">{{ total_instructors|default:'0' }}</span>
                    <p class="text-xs">مدربين</p>
                </div>
                <div class="text-center">
                    <span class="font-bold">{{ total_admins|default:'0' }}</span>
                    <p class="text-xs">أدمن</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm">إجمالي الدورات</p>
                    <h3 class="text-3xl font-bold">{{ total_courses|default:'0' }}</h3>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-book-open text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2 text-sm text-green-100">
                <div class="text-center">
                    <span class="font-bold">{{ active_courses|default:'0' }}</span>
                    <p class="text-xs">نشط</p>
                </div>
                <div class="text-center">
                    <span class="font-bold">{{ featured_courses|default:'0' }}</span>
                    <p class="text-xs">مميز</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-yellow-100 text-sm">إجمالي التسجيلات</p>
                    <h3 class="text-3xl font-bold">{{ total_enrollments|default:'0' }}</h3>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-user-graduate text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2 text-sm text-yellow-100">
                <div class="text-center">
                    <span class="font-bold">{{ completed_enrollments|default:'0' }}</span>
                    <p class="text-xs">مكتمل</p>
                </div>
                <div class="text-center">
                    <span class="font-bold">{{ pending_enrollments_count|default:'0' }}</span>
                    <p class="text-xs">معلق</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm">إجمالي الإيرادات</p>
                    <h3 class="text-3xl font-bold">${{ total_revenue|default:'0' }}</h3>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-dollar-sign text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2 text-sm text-purple-100">
                <div class="text-center">
                    <span class="font-bold">{{ total_reviews|default:'0' }}</span>
                    <p class="text-xs">تقييمات</p>
                </div>
                <div class="text-center">
                    <span class="font-bold">{{ avg_rating|default:'0' }}</span>
                    <p class="text-xs">المعدل</p>
                </div>
            </div>
        </div>
    </div>

    <!-- إحصائيات إضافية من core -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center">
                    <i class="fas fa-envelope text-indigo-600 dark:text-indigo-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">رسائل التواصل</p>
                    <h3 class="text-2xl font-bold">{{ total_contact_messages|default:'0' }}</h3>
                    <p class="text-xs text-green-600">{{ unread_messages|default:'0' }} غير مقروءة</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                    <i class="fas fa-newspaper text-green-600 dark:text-green-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">المشتركين</p>
                    <h3 class="text-2xl font-bold">{{ total_subscribers|default:'0' }}</h3>
                    <p class="text-xs text-green-600">{{ active_subscribers|default:'0' }} نشط</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center">
                    <i class="fas fa-star text-yellow-600 dark:text-yellow-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">شهادات العملاء</p>
                    <h3 class="text-2xl font-bold">{{ total_testimonials|default:'0' }}</h3>
                    <p class="text-xs text-yellow-600">{{ pending_testimonials|default:'0' }} بانتظار المراجعة</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Cards - موسعة لتشمل جميع النماذج -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <a href="{% url 'courses:admin_user_create' %}" 
           class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-l-4 border-blue-500 group">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg group-hover:text-blue-600 transition">إضافة مستخدم</h3>
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center group-hover:scale-110 transition">
                    <i class="fas fa-user-plus text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">إضافة مستخدم جديد إلى المنصة</p>
            <span class="text-blue-600 dark:text-blue-400 text-sm mt-2 inline-block group-hover:translate-x-1 transition">إضافة جديدة →</span>
        </a>

        <a href="{% url 'courses:admin_course_create' %}" 
           class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-l-4 border-green-500 group">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg group-hover:text-green-600 transition">إضافة دورة</h3>
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center group-hover:scale-110 transition">
                    <i class="fas fa-plus-circle text-green-600 dark:text-green-400 text-xl"></i>
                </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">إنشاء دورة تدريبية جديدة</p>
            <span class="text-green-600 dark:text-green-400 text-sm mt-2 inline-block group-hover:translate-x-1 transition">إضافة جديدة →</span>
        </a>

        <a href="{% url 'courses:admin_category_create' %}" 
           class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-l-4 border-purple-500 group">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg group-hover:text-purple-600 transition">إضافة تصنيف</h3>
                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center group-hover:scale-110 transition">
                    <i class="fas fa-folder-plus text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">إضافة تصنيف جديد للدورات</p>
            <span class="text-purple-600 dark:text-purple-400 text-sm mt-2 inline-block group-hover:translate-x-1 transition">إضافة جديدة →</span>
        </a>

        <a href="{% url 'courses:admin_enrollment_create' %}" 
           class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-l-4 border-yellow-500 group">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg group-hover:text-yellow-600 transition">تسجيل يدوي</h3>
                <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center group-hover:scale-110 transition">
                    <i class="fas fa-user-check text-yellow-600 dark:text-yellow-400 text-xl"></i>
                </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">تسجيل طالب في دورة يدوياً</p>
            <span class="text-yellow-600 dark:text-yellow-400 text-sm mt-2 inline-block group-hover:translate-x-1 transition">تسجيل جديد →</span>
        </a>

        <a href="{% url 'courses:admin_orders' %}" 
           class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-l-4 border-red-500 group">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg group-hover:text-red-600 transition">إدارة الطلبات</h3>
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center group-hover:scale-110 transition">
                    <i class="fas fa-shopping-cart text-red-600 dark:text-red-400 text-xl"></i>
                </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">عرض وإدارة طلبات الشراء</p>
            <span class="text-red-600 dark:text-red-400 text-sm mt-2 inline-block group-hover:translate-x-1 transition">
                عرض الطلبات
                {% if pending_orders_count > 0 %}
                <span class="mr-2 bg-red-500 text-white text-xs rounded-full px-2 py-0.5">{{ pending_orders_count }}</span>
                {% endif %}
            </span>
        </a>
    </div>

    <!-- إجراءات سريعة إضافية من core -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <a href="/admin/core/contactmessage/" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow hover:shadow-lg transition flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center">
                <i class="fas fa-envelope text-indigo-600 dark:text-indigo-400"></i>
            </div>
            <div class="flex-1">
                <h4 class="font-semibold">رسائل التواصل</h4>
                <p class="text-sm text-gray-500">إدارة رسائل الزوار</p>
            </div>
            {% if unread_messages > 0 %}
            <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ unread_messages }}</span>
            {% endif %}
        </a>

        <a href="/admin/core/newslettersubscriber/" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow hover:shadow-lg transition flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                <i class="fas fa-users text-green-600 dark:text-green-400"></i>
            </div>
            <div class="flex-1">
                <h4 class="font-semibold">المشتركين</h4>
                <p class="text-sm text-gray-500">إدارة النشرة البريدية</p>
            </div>
        </a>

        <a href="/admin/core/testimonial/" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow hover:shadow-lg transition flex items-center gap-3">
            <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center">
                <i class="fas fa-star text-yellow-600 dark:text-yellow-400"></i>
            </div>
            <div class="flex-1">
                <h4 class="font-semibold">شهادات العملاء</h4>
                <p class="text-sm text-gray-500">إدارة التقييمات</p>
            </div>
            {% if pending_testimonials > 0 %}
            <span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">{{ pending_testimonials }}</span>
            {% endif %}
        </a>
    </div>

    <!-- Main Content Grid - موسع -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Column 1: Users & Reviews -->
        <div class="lg:col-span-2">
            <!-- Users Management -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-users text-primary-600"></i>
                        المستخدمين
                    </h2>
                    <div class="flex gap-2">
                        <a href="{% url 'courses:admin_users' %}" class="text-primary-600 hover:text-primary-700 text-sm font-semibold flex items-center gap-1">
                            عرض الكل
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <a href="{% url 'courses:admin_export_users' %}" class="text-green-600 hover:text-green-700 text-sm font-semibold flex items-center gap-1">
                            <i class="fas fa-download"></i>
                            تصدير
                        </a>
                    </div>
                </div>

                <!-- Role Distribution -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 text-center hover:shadow-md transition">
                        <span class="text-2xl font-bold text-blue-600">{{ total_students|default:'0' }}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">طالب</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 text-center hover:shadow-md transition">
                        <span class="text-2xl font-bold text-green-600">{{ total_instructors|default:'0' }}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">مدرب</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4 text-center hover:shadow-md transition">
                        <span class="text-2xl font-bold text-purple-600">{{ total_admins|default:'0' }}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">أدمن</p>
                    </div>
                </div>

                <!-- Recent Users Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="text-right py-3 px-4">المستخدم</th>
                                <th class="text-right py-3 px-4">الدور</th>
                                <th class="text-right py-3 px-4">تاريخ التسجيل</th>
                                <th class="text-right py-3 px-4">الحالة</th>
                                <th class="text-right py-3 px-4">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_item in users|slice:":5" %}
                            <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition {% if user_item.is_superuser %}bg-purple-50/50 dark:bg-purple-900/10{% endif %}">
                                <td class="py-3 px-4">
                                    <div class="flex items-center gap-3">
                                        {% if user_item.avatar %}
                                        <img src="{{ user_item.avatar.url }}" alt="{{ user_item.get_full_name }}" class="w-8 h-8 rounded-full object-cover">
                                        {% else %}
                                        <div class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center">
                                            <span class="text-primary-600 dark:text-primary-400 font-semibold">{{ user_item.first_name|first|upper }}</span>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <div class="font-semibold text-sm flex items-center gap-1">
                                                {{ user_item.get_full_name|default:user_item.username }}
                                                {% if user_item.is_superuser %}
                                                <span class="px-1.5 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-400 text-[10px] rounded-full font-bold flex items-center gap-0.5">
                                                    <i class="fas fa-crown text-[8px]"></i>
                                                    SUPER
                                                </span>
                                                {% endif %}
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-500">{{ user_item.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold
                                        {% if user_item.is_superuser %}bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-400
                                        {% elif user_item.role == 'admin' %}bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-400
                                        {% elif user_item.role == 'instructor' %}bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-400
                                        {% else %}bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-400{% endif %}">
                                        {% if user_item.is_superuser %}
                                            <i class="fas fa-crown ml-1 text-[10px]"></i>
                                            سوبر أدمن
                                        {% else %}
                                            {{ user_item.get_role_display }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600 dark:text-gray-400">{{ user_item.date_joined|date:'Y-m-d' }}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 text-xs rounded-full {% if user_item.is_active %}bg-green-100 text-green-600{% else %}bg-red-100 text-red-600{% endif %}">
                                        {{ user_item.is_active|yesno:'نشط,غير نشط' }}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex gap-2">
                                        <a href="{% url 'courses:admin_user_detail' user_item.id %}" class="p-1.5 text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition" title="عرض">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'courses:admin_user_edit' user_item.id %}" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-users text-4xl mb-2 opacity-50"></i>
                                    <p>لا يوجد مستخدمين</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Contact Messages -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-envelope text-indigo-600"></i>
                        أحدث رسائل التواصل
                    </h2>
                    <a href="/admin/core/contactmessage/" class="text-primary-600 hover:text-primary-700 text-sm font-semibold">
                        عرض الكل
                        <i class="fas fa-arrow-left mr-1"></i>
                    </a>
                </div>

                {% if recent_messages %}
                <div class="space-y-4">
                    {% for message in recent_messages %}
                    <div class="border-b border-gray-200 dark:border-gray-700 last:border-0 pb-4 last:pb-0">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-semibold">{{ message.name }}</h4>
                                <p class="text-xs text-gray-500">{{ message.email }}</p>
                            </div>
                            <span class="text-xs text-gray-500">{{ message.created_at|date:'Y-m-d H:i' }}</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 line-clamp-2">{{ message.message }}</p>
                        <div class="flex gap-2">
                            {% if not message.is_read %}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-600 text-xs rounded-full">غير مقروءة</span>
                            {% endif %}
                            <span class="text-xs text-gray-500">{{ message.subject|truncatechars:30 }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-gray-500 dark:text-gray-400 py-4">لا توجد رسائل تواصل</p>
                {% endif %}
            </div>

            <!-- Courses Management -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-book-open text-primary-600"></i>
                        الدورات
                    </h2>
                    <div class="flex gap-2">
                        <a href="{% url 'courses:admin_courses' %}" class="text-primary-600 hover:text-primary-700 text-sm font-semibold flex items-center gap-1">
                            عرض الكل
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <a href="{% url 'courses:admin_export_courses' %}" class="text-green-600 hover:text-green-700 text-sm font-semibold flex items-center gap-1">
                            <i class="fas fa-download"></i>
                            تصدير
                        </a>
                    </div>
                </div>

                <!-- Status Distribution -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-primary-50 dark:bg-primary-900/20 rounded-xl p-4 text-center hover:shadow-md transition">
                        <span class="text-2xl font-bold text-primary-600">{{ total_courses|default:'0' }}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">إجمالي</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 text-center hover:shadow-md transition">
                        <span class="text-2xl font-bold text-green-600">{{ active_courses|default:'0' }}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">نشط</p>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl p-4 text-center hover:shadow-md transition">
                        <span class="text-2xl font-bold text-yellow-600">{{ featured_courses|default:'0' }}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">مميز</p>
                    </div>
                </div>

                <!-- Recent Courses Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="text-right py-3 px-4">الدورة</th>
                                <th class="text-right py-3 px-4">المدرب</th>
                                <th class="text-right py-3 px-4">السعر</th>
                                <th class="text-right py-3 px-4">الحالة</th>
                                <th class="text-right py-3 px-4">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course_item in courses|slice:":5" %}
                            <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                                <td class="py-3 px-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg overflow-hidden">
                                            {% if course_item.image %}
                                            <img src="{{ course_item.image.url }}" alt="{{ course_item.title }}" class="w-full h-full object-cover">
                                            {% else %}
                                            <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                                <i class="fas fa-image text-gray-400"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="font-semibold text-sm">{{ course_item.title|truncatechars:30 }}</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-500">{{ course_item.category.name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm">{{ course_item.instructor.get_full_name|default:course_item.instructor.username }}</td>
                                <td class="py-3 px-4 text-sm font-bold text-primary-600">${{ course_item.price }}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 text-xs rounded-full {% if course_item.is_active %}bg-green-100 text-green-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                                        {{ course_item.is_active|yesno:'نشط,غير نشط' }}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex gap-2">
                                        <a href="{% url 'courses:admin_course_detail' course_item.id %}" class="p-1.5 text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition" title="عرض">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'courses:admin_course_edit' course_item.id %}" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-book-open text-4xl mb-2 opacity-50"></i>
                                    <p>لا توجد دورات</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Column 2: Sidebar - مع طلبات التسجيل والطلبات -->
        <div class="lg:col-span-1">
        <!-- Pending Enrollments - طلبات التسجيل في الدورات -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-clock text-yellow-500"></i>
                    طلبات التسجيل في الدورات
                    {% if pending_enrollments_count > 0 %}
                    <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-600 rounded-full">{{ pending_enrollments_count }}</span>
                    {% endif %}
                </h2>
                <a href="{% url 'courses:admin_enrollments' %}?status=pending" class="text-primary-600 hover:text-primary-700 text-sm">
                    عرض الكل
                    <i class="fas fa-arrow-left mr-1"></i>
                </a>
            </div>
            
            {% if pending_enrollments %}
            <div class="space-y-4">
                {% for enrollment in pending_enrollments %}
                <div class="flex items-center justify-between p-3 rounded-lg transition
                            {% if enrollment.course.price == 0 %}
                            bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30
                            {% else %}
                            bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/30
                            {% endif %}">
                    <div class="flex items-center gap-3">
                        {% if enrollment.user.avatar %}
                        <img src="{{ enrollment.user.avatar.url }}" alt="{{ enrollment.user.get_full_name }}" class="w-10 h-10 rounded-full object-cover">
                        {% else %}
                        <div class="w-10 h-10 rounded-full {% if enrollment.course.price == 0 %}bg-green-100 dark:bg-green-900{% else %}bg-yellow-100 dark:bg-yellow-900{% endif %} flex items-center justify-center">
                            <span class="{% if enrollment.course.price == 0 %}text-green-600 dark:text-green-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %} font-semibold">
                                {{ enrollment.user.first_name|first|upper }}
                            </span>
                        </div>
                        {% endif %}
                        <div>
                            <h4 class="font-semibold text-sm">{{ enrollment.user.get_full_name|default:enrollment.user.username }}</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-500">{{ enrollment.course.title|truncatechars:20 }}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-400">{{ enrollment.enrolled_at|date:'Y-m-d' }}</span>
                                {% if enrollment.course.price == 0 %}
                                <span class="px-2 py-0.5 bg-green-200 dark:bg-green-800 text-green-700 dark:text-green-300 text-xs rounded-full">
                                    <i class="fas fa-gift ml-1"></i> مجانية
                                </span>
                                {% else %}
                                <span class="px-2 py-0.5 bg-yellow-200 dark:bg-yellow-800 text-yellow-700 dark:text-yellow-300 text-xs rounded-full">
                                    {{ enrollment.course.price }} ج.م
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <a href="{% url 'courses:admin_enrollment_update_status' enrollment.id %}?status=enrolled" 
                        class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center hover:bg-green-200 dark:hover:bg-green-800 transition" 
                        title="قبول"
                        onclick="return confirm('هل أنت متأكد من قبول هذا التسجيل؟')">
                            <i class="fas fa-check text-green-600"></i>
                        </a>
                        <a href="{% url 'courses:admin_enrollment_update_status' enrollment.id %}?status=cancelled" 
                        class="w-8 h-8 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center hover:bg-red-200 dark:hover:bg-red-800 transition" 
                        title="رفض"
                        onclick="return confirm('هل أنت متأكد من رفض هذا التسجيل؟')">
                            <i class="fas fa-times text-red-600"></i>
                        </a>
                        <a href="{% url 'courses:admin_enrollment_detail' enrollment.id %}" class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center hover:bg-blue-200 dark:hover:bg-blue-800 transition" title="عرض التفاصيل">
                            <i class="fas fa-eye text-blue-600"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-check-circle text-4xl mb-2 opacity-50"></i>
                <p>لا توجد طلبات تسجيل معلقة</p>
            </div>
            {% endif %}
        </div>
            <!-- Pending Orders - طلبات الشراء الجديدة -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-shopping-cart text-green-600"></i>
                        طلبات الشراء الجديدة
                        {% if pending_orders_count > 0 %}
                        <span class="px-2 py-1 text-xs bg-green-100 text-green-600 rounded-full">{{ pending_orders_count }}</span>
                        {% endif %}
                    </h2>
                    <a href="{% url 'courses:admin_orders' %}?status=pending" class="text-primary-600 hover:text-primary-700 text-sm">
                        عرض الكل
                        <i class="fas fa-arrow-left mr-1"></i>
                    </a>
                </div>
                
                {% if pending_orders %}
                <div class="space-y-4">
                    {% for order in pending_orders %}
                    <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition">
                        <div class="flex items-center gap-3">
                            {% if order.user.avatar %}
                            <img src="{{ order.user.avatar.url }}" alt="{{ order.user.get_full_name }}" class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                            <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center">
                                <span class="text-green-600 dark:text-green-400 font-semibold">{{ order.user.first_name|first|upper }}</span>
                            </div>
                            {% endif %}
                            <div>
                                <h4 class="font-semibold text-sm">{{ order.customer_name|default:order.user.get_full_name|default:order.user.username }}</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-500">{{ order.items.count }} دورات | {{ order.total }} ج.م</p>
                                <p class="text-xs text-gray-400 mt-1">#{{ order.id }} - {{ order.created_at|date:'Y-m-d' }}</p>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <a href="{% url 'courses:admin_order_detail' order.id %}" class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center hover:bg-blue-200 dark:hover:bg-blue-800 transition" title="عرض التفاصيل">
                                <i class="fas fa-eye text-blue-600"></i>
                            </a>
                            <a href="{% url 'courses:admin_order_update_status' order.id %}?status=completed" 
                               class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center hover:bg-green-200 dark:hover:bg-green-800 transition" 
                               title="تأكيد الدفع"
                               onclick="return confirm('هل أنت متأكد من تأكيد دفع هذا الطلب؟ سيتم تفعيل الدورات للمستخدم.')">
                                <i class="fas fa-check text-green-600"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-shopping-cart text-4xl mb-2 opacity-50"></i>
                    <p>لا توجد طلبات شراء جديدة</p>
                </div>
                {% endif %}
            </div>

            <!-- Recent Reviews -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-star text-yellow-500"></i>
                        أحدث التقييمات
                    </h2>
                    <a href="{% url 'courses:admin_reviews' %}" class="text-primary-600 hover:text-primary-700 text-sm">
                        عرض الكل
                    </a>
                </div>
                
                {% if recent_reviews %}
                <div class="space-y-4">
                    {% for review in recent_reviews %}
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-3 last:border-0 last:pb-0 hover:bg-gray-50 dark:hover:bg-gray-700/20 p-2 rounded-lg transition">
                        <div class="flex justify-between mb-1">
                            <span class="font-semibold text-sm">{{ review.user.get_full_name|default:review.user.username }}</span>
                            <div class="flex">
                                {% for i in "12345"|make_list %}
                                {% if forloop.counter <= review.rating %}
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1 line-clamp-2">{{ review.comment }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-500">{{ review.course.title|truncatechars:30 }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-star text-4xl mb-2 opacity-50"></i>
                    <p>لا توجد تقييمات حديثة</p>
                </div>
                {% endif %}
            </div>

            <!-- Recent Testimonials -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-quote-right text-indigo-600"></i>
                        شهادات العملاء
                    </h2>
                    <a href="/admin/core/testimonial/" class="text-primary-600 hover:text-primary-700 text-sm">
                        إدارة
                    </a>
                </div>
                
                {% if recent_testimonials %}
                <div class="space-y-4">
                    {% for testimonial in recent_testimonials %}
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-3 last:border-0 last:pb-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-sm">{{ testimonial.name }}</span>
                            {% if not testimonial.is_active %}
                            <span class="px-2 py-0.5 bg-yellow-100 text-yellow-600 text-xs rounded-full">بانتظار الموافقة</span>
                            {% endif %}
                        </div>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1 line-clamp-2">"{{ testimonial.content }}"</p>
                        <p class="text-xs text-gray-500">{{ testimonial.position }} - {{ testimonial.company }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-gray-500 dark:text-gray-400 py-4">لا توجد شهادات</p>
                {% endif %}
            </div>

            <!-- Categories Summary -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-folder text-primary-600"></i>
                        التصنيفات
                    </h2>
                    <a href="{% url 'courses:admin_categories' %}" class="text-primary-600 hover:text-primary-700 text-sm">
                        إدارة
                    </a>
                </div>
                
                {% if categories %}
                <div class="space-y-3">
                    {% for category in categories|slice:":5" %}
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-{{ category.icon|default:'folder' }} text-primary-600"></i>
                            <span class="text-sm">{{ category.name }}</span>
                        </div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">{{ category.courses_count }} دورة</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-folder-open text-4xl mb-2 opacity-50"></i>
                    <p>لا توجد تصنيفات</p>
                </div>
                {% endif %}
            </div>

            <!-- Newsletter Subscribers -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-newspaper text-green-600"></i>
                        أحدث المشتركين
                    </h2>
                    <a href="/admin/core/newslettersubscriber/" class="text-primary-600 hover:text-primary-700 text-sm">
                        إدارة
                    </a>
                </div>
                
                {% if recent_subscribers %}
                <div class="space-y-3">
                    {% for subscriber in recent_subscribers|slice:":5" %}
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition">
                        <div>
                            <span class="text-sm font-medium">{{ subscriber.email|truncatechars:25 }}</span>
                            {% if subscriber.name %}
                            <p class="text-xs text-gray-500">{{ subscriber.name }}</p>
                            {% endif %}
                        </div>
                        {% if subscriber.is_verified %}
                        <span class="px-2 py-0.5 bg-green-100 text-green-600 text-xs rounded-full">موثق</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-gray-500 dark:text-gray-400 py-4">لا يوجد مشتركين</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Level Distribution Chart -->
    <div class="mt-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
            <i class="fas fa-chart-pie text-primary-600"></i>
            توزيع مستويات الدورات
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-xl hover:shadow-md transition">
                <div class="text-3xl font-bold text-green-600">{{ level_distribution.beginner|default:'0' }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">مبتدئ</div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-green-600 rounded-full h-2 transition-all duration-500" style="width: {% widthratio level_distribution.beginner|default:0 total_courses|default:1 100 %}%"></div>
                </div>
            </div>
            <div class="text-center p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl hover:shadow-md transition">
                <div class="text-3xl font-bold text-yellow-600">{{ level_distribution.intermediate|default:'0' }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">متوسط</div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-yellow-600 rounded-full h-2 transition-all duration-500" style="width: {% widthratio level_distribution.intermediate|default:0 total_courses|default:1 100 %}%"></div>
                </div>
            </div>
            <div class="text-center p-4 bg-red-50 dark:bg-red-900/20 rounded-xl hover:shadow-md transition">
                <div class="text-3xl font-bold text-red-600">{{ level_distribution.advanced|default:'0' }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">متقدم</div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-red-600 rounded-full h-2 transition-all duration-500" style="width: {% widthratio level_distribution.advanced|default:0 total_courses|default:1 100 %}%"></div>
                </div>
            </div>
            <div class="text-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl hover:shadow-md transition">
                <div class="text-3xl font-bold text-gray-600">{{ level_distribution.all|default:'0' }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">جميع المستويات</div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-gray-600 rounded-full h-2 transition-all duration-500" style="width: {% widthratio level_distribution.all|default:0 total_courses|default:1 100 %}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // تحديث البيانات بشكل دوري (اختياري)
    function refreshDashboard() {
        fetch('/ajax/dashboard-stats/')
            .then(response => response.json())
            .then(data => {
                console.log('تم تحديث البيانات', data);
                // هنا يمكنك تحديث بعض العناصر دون إعادة تحميل الصفحة
            })
            .catch(error => console.error('خطأ في تحديث البيانات:', error));
    }
    
    // تحديث كل 5 دقائق
    // setInterval(refreshDashboard, 300000);
</script>
{% endblock %}