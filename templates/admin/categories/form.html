{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">{{ title }}</h1>
    <p class="text-gray-600 dark:text-gray-400">أدخل معلومات التصنيف الجديد</p>
  </div>

  <!-- Form -->
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
    <!-- مهم: إضافة enctype لرفع الملفات -->
    <form method="post" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}
      
      {% if form.non_field_errors %}
      <div class="bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg">
        {% for error in form.non_field_errors %}
        <p class="flex items-center gap-2">
          <i class="fas fa-exclamation-circle"></i>
          {{ error }}
        </p>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Name -->
      <div>
        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium mb-2">
          {{ form.name.label }} 
          {% if form.name.field.required %}<span class="text-red-500">*</span>{% endif %}
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <i class="fas fa-tag text-gray-400"></i>
          </div>
          {{ form.name }}
        </div>
        {% if form.name.errors %}
        <p class="mt-1 text-sm text-red-600 flex items-center gap-1">
          <i class="fas fa-times-circle"></i>
          {{ form.name.errors.0 }}
        </p>
        {% endif %}
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
          <i class="fas fa-info-circle"></i>
          سيتم إنشاء slug تلقائياً من الاسم
        </p>
      </div>

      <!-- Description -->
      <div>
        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium mb-2">
          {{ form.description.label }}
        </label>
        <div class="relative">
          <div class="absolute top-3 right-0 pr-3 flex pointer-events-none">
            <i class="fas fa-align-left text-gray-400"></i>
          </div>
          {{ form.description }}
        </div>
        {% if form.description.errors %}
        <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Icon -->
      <div>
        <label for="{{ form.icon.id_for_label }}" class="block text-sm font-medium mb-2">
          {{ form.icon.label }}
        </label>
        <div class="flex gap-2 items-center">
          <div class="relative flex-1">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <i class="fas fa-icons text-gray-400"></i>
            </div>
            {{ form.icon }}
          </div>
          <div class="w-12 h-12 bg-gradient-to-br from-primary-100 to-primary-200 dark:from-primary-900 dark:to-primary-800 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md">
            <i class="fas fa-{% if form.icon.value %}{{ form.icon.value }}{% else %}folder{% endif %} text-2xl text-primary-600 dark:text-primary-400 preview-icon"></i>
          </div>
        </div>
        {% if form.icon.errors %}
        <p class="mt-1 text-sm text-red-600">{{ form.icon.errors.0 }}</p>
        {% endif %}
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          <i class="fas fa-lightbulb ml-1"></i>
          مثال: code, chart-line, language, paint-brush
        </p>
      </div>

      <!-- Image Gat - تم التعديل هنا -->
      <div class="bg-gray-50 dark:bg-gray-700/30 rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-image text-primary-600"></i>
          صورة التصنيف
        </h3>
        
        <div>
          <label for="{{ form.img_gat.id_for_label }}" class="block text-sm font-medium mb-2">
            {{ form.img_gat.label }}
          </label>
          
          <!-- حقل رفع الصورة -->
          <div class="mt-1">
            {{ form.img_gat }}
          </div>
          
          {% if form.img_gat.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.img_gat.errors.0 }}</p>
          {% endif %}
          
          <!-- معاينة الصورة الحالية (إذا كانت موجودة) -->
          {% if form.instance.img_gat %}
          <div class="mt-4 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
            <p class="text-sm font-medium mb-3 flex items-center gap-2">
              <i class="fas fa-image text-green-600"></i>
              الصورة الحالية:
            </p>
            <div class="flex items-center gap-4">
              <div class="relative w-24 h-24 rounded-xl overflow-hidden border-2 border-primary-200 dark:border-primary-800 shadow-lg">
                <img src="{{ form.instance.img_gat.url }}" alt="{{ form.instance.name }}" class="w-full h-full object-cover">
              </div>
              <div class="flex-1">
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ form.instance.img_gat.name|truncatechars:30 }}</p>
                <p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-info-circle ml-1"></i>
                  ارفع صورة جديدة لاستبدالها
                </p>
              </div>
            </div>
          </div>
          {% endif %}
          
          <!-- معاينة مؤقتة للصورة الجديدة -->
          <div id="image-preview-container" class="mt-4 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-primary-200 dark:border-primary-800">
              <p class="text-sm font-medium mb-3 flex items-center gap-2">
                <i class="fas fa-eye text-primary-600"></i>
                معاينة الصورة الجديدة:
              </p>
              <div class="flex items-center gap-4">
                <div class="relative w-24 h-24 rounded-xl overflow-hidden border-2 border-primary-500 shadow-lg">
                  <img id="image-preview" src="#" alt="Preview" class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                  <p id="file-name" class="text-sm text-gray-600 dark:text-gray-400"></p>
                  <p id="file-size" class="text-xs text-gray-500 mt-1"></p>
                </div>
              </div>
            </div>
          </div>
          
          <p class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-info-circle text-primary-600"></i>
            الصورة المرفوعة ستظهر بدلاً من الأيقونة في الصفحة الرئيسية
          </p>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            <i class="fas fa-file-image ml-1"></i>
            الصيغ المسموحة: JPG, PNG, GIF - الحد الأقصى: 5 ميجابايت
          </p>
        </div>
      </div>

      <!-- Parent Category -->
      <div>
        <label for="{{ form.parent.id_for_label }}" class="block text-sm font-medium mb-2">
          {{ form.parent.label }}
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <i class="fas fa-sitemap text-gray-400"></i>
          </div>
          {{ form.parent }}
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-chevron-down text-gray-400"></i>
          </div>
        </div>
        {% if form.parent.errors %}
        <p class="mt-1 text-sm text-red-600">{{ form.parent.errors.0 }}</p>
        {% endif %}
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          <i class="fas fa-info-circle ml-1"></i>
          اختر تصنيف أب إذا كان هذا تصنيفاً فرعياً
        </p>
      </div>

      <!-- Form Actions -->
      <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
        <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-l from-primary-600 to-primary-700 text-white rounded-xl hover:from-primary-700 hover:to-primary-800 transition transform hover:scale-105 font-semibold flex items-center justify-center gap-2 shadow-lg">
          <i class="fas fa-save"></i>
          حفظ
        </button>
        <a href="{% url 'courses:admin_categories' %}" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition transform hover:scale-105 font-semibold flex items-center justify-center gap-2">
          <i class="fas fa-times"></i>
          إلغاء
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Preview icon when typing
  const iconInput = document.getElementById("{{ form.icon.id_for_label }}");
  if (iconInput) {
    iconInput.addEventListener("input", function (e) {
      const iconName = e.target.value || "folder";
      const previewIcon = document.querySelector(".preview-icon");
      if (previewIcon) {
        previewIcon.className = `fas fa-${iconName} text-2xl text-primary-600 dark:text-primary-400 preview-icon`;
      }
    });
  }

  // Preview image when selected
  const imageInput = document.getElementById("{{ form.img_gat.id_for_label }}");
  if (imageInput) {
    imageInput.addEventListener("change", function(e) {
      const file = e.target.files[0];
      const previewContainer = document.getElementById('image-preview-container');
      const preview = document.getElementById('image-preview');
      const fileName = document.getElementById('file-name');
      const fileSize = document.getElementById('file-size');
      
      if (file) {
        // التحقق من نوع الملف
        if (!file.type.startsWith('image/')) {
          showNotification('❌ الرجاء اختيار ملف صورة فقط', 'error');
          this.value = '';
          previewContainer.classList.add('hidden');
          return;
        }
        
        // التحقق من حجم الملف (أقل من 5 ميجابايت)
        if (file.size > 5 * 1024 * 1024) {
          showNotification('❌ حجم الصورة كبير جداً. الرجاء اختيار صورة أقل من 5 ميجابايت', 'error');
          this.value = '';
          previewContainer.classList.add('hidden');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          
          // عرض اسم الملف وحجمه
          if (fileName) {
            fileName.textContent = file.name;
          }
          if (fileSize) {
            const sizeInKB = (file.size / 1024).toFixed(1);
            fileSize.innerHTML = `<i class="fas fa-database ml-1"></i>الحجم: ${sizeInKB} كيلوبايت`;
          }
          
          previewContainer.classList.remove('hidden');
          previewContainer.classList.add('animate__animated', 'animate__fadeIn');
        };
        reader.readAsDataURL(file);
      } else {
        previewContainer.classList.add('hidden');
      }
    });
  }

  // دالة عرض الإشعارات
  function showNotification(message, type = 'success') {
    // يمكنك استخدام دالة showNotification الموجودة في base.html
    if (typeof window.showNotification === 'function') {
      window.showNotification(message, type);
    } else {
      alert(message);
    }
  }
</script>

<!-- إضافة بعض التحسينات البصرية -->
<style>
  /* تحسين شكل حقل رفع الملف */
  input[type="file"] {
    @apply w-full px-4 py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 dark:file:bg-primary-900 dark:file:text-primary-300;
    background: linear-gradient(45deg, transparent 50%, rgba(59, 130, 246, 0.05) 50%);
    background-size: 8px 8px;
  }
  
  /* تحسين معاينة الصورة */
  #image-preview-container {
    animation: fadeInUp 0.4s ease-out;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* تحسين ظهور الحقول */
  input[type="text"], 
  input[type="file"],
  select,
  textarea {
    transition: all 0.3s ease;
  }
  
  input[type="text"]:focus,
  select:focus,
  textarea:focus {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
</style>
{% endblock %}