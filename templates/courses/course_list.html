{% extends 'base.html' %}
{% load static %}

{% block title %}الدورات التدريبية - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-4">الدورات التدريبية</h1>
        <p class="text-gray-600 dark:text-gray-400">تصفح مجموعتنا المتنوعة من الدورات التدريبية في مختلف المجالات</p>
    </div>

    <!-- Filters Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <!-- Search -->
            <div class="lg:col-span-2">
                <label class="block text-sm font-medium mb-2">بحث</label>
                <div class="relative">
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" name="search" value="{{ request.GET.search }}" 
                           placeholder="ابحث عن دورة..." 
                           class="w-full pr-10 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                </div>
            </div>

            <!-- Category Filter -->
            <div>
                <label class="block text-sm font-medium mb-2">التصنيف</label>
                <select name="category" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                    <option value="">جميع التصنيفات</option>
                    {% for category in categories %}
                    <option value="{{ category.slug }}" {% if request.GET.category == category.slug %}selected{% endif %}>
                        {{ category.name }} ({{ category.course_count }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Level Filter -->
            <div>
                <label class="block text-sm font-medium mb-2">المستوى</label>
                <select name="level" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                    <option value="">جميع المستويات</option>
                    {% for level_value, level_name in levels %}
                    <option value="{{ level_value }}" {% if request.GET.level == level_value %}selected{% endif %}>
                        {{ level_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Sort By -->
            <div>
                <label class="block text-sm font-medium mb-2">ترتيب حسب</label>
                <select name="sort" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                    <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>الأحدث</option>
                    <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>الأقدم</option>
                    <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>السعر: من الأعلى</option>
                    <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>السعر: من الأقل</option>
                    <option value="-rating" {% if request.GET.sort == '-rating' %}selected{% endif %}>التقييم</option>
                    <option value="title" {% if request.GET.sort == 'title' %}selected{% endif %}>الاسم</option>
                </select>
            </div>

            <!-- Filter Button -->
            <div class="flex items-end">
                <button type="submit" class="w-full px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition font-semibold">
                    <i class="fas fa-filter ml-2"></i>
                    تطبيق الفلاتر
                </button>
            </div>
        </form>

        <!-- Price Range (Advanced Filters) -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button type="button" onclick="toggleAdvancedFilters()" class="text-primary-600 hover:text-primary-700 font-semibold flex items-center">
                <i class="fas fa-chevron-down ml-2" id="advancedFiltersIcon"></i>
                فلاتر متقدمة
            </button>
            
            <div id="advancedFilters" class="hidden mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">السعر من</label>
                    <input type="number" name="price_min" value="{{ request.GET.price_min }}" 
                           placeholder="أقل سعر" 
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">السعر إلى</label>
                    <input type="number" name="price_max" value="{{ request.GET.price_max }}" 
                           placeholder="أعلى سعر" 
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">التقييم</label>
                    <select name="rating" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-700">
                        <option value="">جميع التقييمات</option>
                        <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>٤ نجوم فأكثر</option>
                        <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>٣ نجوم فأكثر</option>
                        <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>نجمتين فأكثر</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Count -->
    <div class="flex justify-between items-center mb-6">
        <p class="text-gray-600 dark:text-gray-400">
            <span class="font-bold text-primary-600">{{ page_obj.paginator.count }}</span> دورة متاحة
        </p>
    </div>

    <!-- Courses Grid -->
    {% if courses %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for course in courses %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden group">
            <!-- Course Image -->
            <div class="relative h-48 overflow-hidden">
                {% if course.image %}
                <img src="{{ course.image.url }}" alt="{{ course.title }}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                {% else %}
                <img src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80" 
                     alt="{{ course.title }}" 
                     class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                {% endif %}
                
                <!-- Badges -->
                <div class="absolute top-3 right-3 flex gap-2">
                    {% if course.is_featured %}
                    <span class="bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-bold">
                        <i class="fas fa-star ml-1"></i> مميزة
                    </span>
                    {% endif %}
                    {% if course.price == 0 %}
                    <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                        <i class="fas fa-gift ml-1"></i> مجانية
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Course Content -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-1 bg-primary-50 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 text-xs rounded-full">
                        {{ course.category.name }}
                    </span>
                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs rounded-full">
                        <i class="fas fa-signal ml-1"></i> {{ course.get_level_display }}
                    </span>
                </div>

                <h3 class="font-semibold mb-2 line-clamp-2 h-12">
                    <a href="{% url 'courses:course_detail' course.slug %}" class="hover:text-primary-600 dark:hover:text-primary-400">
                        {{ course.title }}
                    </a>
                </h3>

                <!-- Instructor -->
                <div class="flex items-center gap-2 mb-3">
                    {% if course.instructor.avatar %}
                    <img src="{{ course.instructor.avatar.url }}" alt="{{ course.instructor.get_full_name }}" class="w-6 h-6 rounded-full object-cover">
                    {% else %}
                    <div class="w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center">
                        <span class="text-xs text-primary-600 dark:text-primary-400 font-semibold">{{ course.instructor.first_name|first|upper }}</span>
                    </div>
                    {% endif %}
                    <span class="text-sm text-gray-600 dark:text-gray-400">{{ course.instructor.get_full_name|default:course.instructor.username }}</span>
                </div>

                <!-- Rating & Price -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-1">
                        <div class="flex">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= course.rating %}
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                {% elif forloop.counter <= course.rating|add:"0.5" %}
                                <i class="fas fa-star-half-alt text-yellow-400 text-xs"></i>
                                {% else %}
                                <i class="far fa-star text-yellow-400 text-xs"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="text-xs text-gray-500 dark:text-gray-500">({{ course.reviews.count }})</span>
                    </div>
                    <div class="font-bold text-primary-600 dark:text-primary-400">
                        {% if course.price == 0 %}
                        <span class="text-green-600 dark:text-green-400">مجاناً</span>
                        {% else %}
                        ${{ course.price }}
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Info -->
                <div class="mt-3 flex items-center gap-3 text-xs text-gray-500 dark:text-gray-500">
                    <span><i class="fas fa-users ml-1"></i> {{ course.students_count }}</span>
                    <span><i class="fas fa-clock ml-1"></i> {{ course.duration_hours }} ساعة</span>
                    <span><i class="fas fa-book-open ml-1"></i> {{ course.get_lessons_count }} درس</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="mt-10 flex justify-center">
        <nav class="flex items-center gap-2" aria-label="Pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
               class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}

            {% for i in paginator.page_range %}
                {% if page_obj.number == i %}
                <span class="px-4 py-2 bg-primary-600 text-white rounded-lg">{{ i }}</span>
                {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                <a href="?page={{ i }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
                   class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    {{ i }}
                </a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
               class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}

    {% else %}
    <!-- No Results -->
    <div class="text-center py-20">
        <div class="text-8xl mb-4 text-gray-300 dark:text-gray-600">
            <i class="fas fa-search"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2">لا توجد نتائج</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6">لم نتمكن من العثور على دورات تطابق بحثك</p>
        <a href="{% url 'courses:course_list' %}" class="px-6 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition">
            <i class="fas fa-redo-alt ml-2"></i>
            إعادة ضبط الفلاتر
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block extra_js %}
<script>
    function toggleAdvancedFilters() {
        const filters = document.getElementById('advancedFilters');
        const icon = document.getElementById('advancedFiltersIcon');
        
        if (filters.classList.contains('hidden')) {
            filters.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            filters.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }

    // Auto-hide advanced filters if they have values
    {% if request.GET.price_min or request.GET.price_max or request.GET.rating %}
    document.getElementById('advancedFilters').classList.remove('hidden');
    document.getElementById('advancedFiltersIcon').classList.remove('fa-chevron-down');
    document.getElementById('advancedFiltersIcon').classList.add('fa-chevron-up');
    {% endif %}
</script>
{% endblock %}